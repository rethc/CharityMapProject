<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Registered Charities in New Zealand with an interactive map displaying locations and details of charitable organisations." />
        <title>Charities Services - Registered Charities Map</title>
        <link rel="icon" href="favicon.ico" type="image/x-icon" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw==" crossorigin="" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.min.css"
            integrity="sha512-ENrTWqddXrLJsQS2A86QmvA17PkJ0GVm1bqj5aTgpeMAfDKN2+SIOLpKG8R/6KkimnhTb+VW5qqUHB/r1zaRgg=="
            crossorigin=""
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css"
            integrity="sha512-fYyZwU1wU0QWB4Yutd/Pvhy5J1oWAwFXun1pt+Bps04WSe4Aq6tyHlT4+MHSJhD8JlLfgLuC4CbCnX5KHSjyCg=="
            crossorigin=""
        />
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" integrity="sha512-+uXbfI7GqghCnQUzxdA4P2cOwH00xc9s5gN551DUHWugGG1kOITswJniBDX4fQecqtWSoDUoJ4s1igb53PGENQ==" crossorigin="" />
        <link rel="stylesheet" href="styles.css" />
    </head>
    <!-- Google tag(gtag.js)-->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9S3FM53SXQ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag("js", new Date());
        gtag("config", "G-9S3FM53SXQ");
    </script>
    <body>
        <div id="charity-search-container" class="leaflet-control-geocoder leaflet-bar leaflet-control">
            <button class="leaflet-control-geocoder-icon" id="charity-search-btn" type="button" aria-label="Search">&nbsp;</button>
            <div class="leaflet-control-geocoder-form"><input id="charity-search-input" class="leaflet-control-geocoder-input" type="text" placeholder="Search by Charity Registration (CC number)" /></div>
            <div class="leaflet-control-geocoder-form-no-error">Nothing found.</div>
            <ul class="leaflet-control-geocoder-alternatives leaflet-control-geocoder-alternatives-minimized"></ul>
        </div>
        <div id="map"></div>
        <div class="watermark-container"><img src="charities-logo.svg" alt="Charities Services Logo" width="200" height="78.2656px" loading="lazy" /></div>
        <div id="loading-spinner"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g==" crossorigin=""></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"
            integrity="sha512-TiMWaqipFi2Vqt4ugRzsF8oRoGFlFFuqIi30FFxEPNw58Ov9mOy6LgC05ysfkxwLE0xVeZtmr92wVg9siAFRWA=="
            crossorigin=""
        ></script>
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" integrity="sha512-qh/P3G5pJ41NomJU64K7iqtrGpjd1odJapzykgv3Ch5pHc0ecjZahh4huIsmvTPXDRwvI86mqh2AbbLwZRS8Cw==" crossorigin=""></script>
        <script>
            var map = L.map("map", { attributionControl: !0, worldCopyJump: !0, minZoom: 4, crs: L.CRS.EPSG2193 }).setView([-40.9006, 174.886], 6);
            var attribution = 'Registered Charities in New Zealand | &copy; <a href="https://carto.com/">Carto</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>';
            var polygons = [];
            var spinner = document.getElementById("loading-spinner");
            spinner.style.display = "block";
            L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", { attribution: attribution }).addTo(map);
            map.attributionControl.setPrefix("");
            var charityData = [];
            var groupData = [];
            var charityMarkersCluster = L.markerClusterGroup({ animateAddingMarkers: !0, showCoverageOnHover: !0, spiderfyOnMaxZoom: !0 });
            var groupMarkersCluster = L.markerClusterGroup({ animateAddingMarkers: !0, showCoverageOnHover: !1, spiderfyOnMaxZoom: !0 });
            var combinedMarkersCluster = L.markerClusterGroup({ animateAddingMarkers: !0, showCoverageOnHover: !1, spiderfyOnMaxZoom: !0 });
            if (window.Worker) {
                var charityWorker = new Worker("csv-worker.js");
                charityWorker.postMessage({ csvFile: "combined_charities_data.csv", markerType: "charity" });
                charityWorker.onmessage = function (e) {
                    charityData = e.data;
                    var charityMarkers = [];
                    charityData.forEach(function (markerInfo) {
                        var marker = L.marker([markerInfo.lat, markerInfo.lon]).bindPopup(markerInfo.popupContent);
                        charityMarkers.push(marker);
                        combinedMarkersCluster.addLayer(marker);
                    });
                    charityMarkersCluster.addLayers(charityMarkers);
                    map.addLayer(charityMarkersCluster);
                    spinner.style.display = "none";
                };
                var groupWorker = new Worker("csv-worker.js");
                groupWorker.postMessage({ csvFile: "combined_groups_data.csv", markerType: "group" });
                groupWorker.onmessage = function (e) {
                    groupData = e.data;
                    var groupMarkers = [];
                    var greenIcon = new L.Icon({ iconUrl: "marker-icon-2x-green.png", shadowUrl: "marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
                    groupData.forEach(function (markerInfo) {
                        var marker = L.marker([markerInfo.lat, markerInfo.lon], { icon: greenIcon }).bindPopup(markerInfo.popupContent);
                        groupMarkers.push(marker);
                        combinedMarkersCluster.addLayer(marker);
                    });
                    groupMarkersCluster.addLayers(groupMarkers);
                };
            } else {
                console.log("Web Workers are not supported in your browser.");
            }
            var baseMaps = { Charities: charityMarkersCluster, Groups: groupMarkersCluster, "Charities and Groups": combinedMarkersCluster };
            L.control.layers(baseMaps).addTo(map);
            var charitySearchButton = document.getElementById("charity-search-btn");
            var charitySearchInput = document.getElementById("charity-search-input");
            var charitySearchContainer = document.getElementById("charity-search-container");
            const layerControl = document.querySelector(".leaflet-control-layers");
            let searchCharityTop = parseInt(window.getComputedStyle(charitySearchContainer).top, 10);
            function moveSearchContainerDown() {
                charitySearchContainer.style.setProperty("top", `${searchCharityTop + 29}px`, "important");
            }
            function moveSearchContainerUp() {
                charitySearchContainer.style.setProperty("top", `${searchCharityTop}px`, "important");
            }
            window.onload = function () {
                if (layerControl) {
                    layerControl.addEventListener("mouseover", moveSearchContainerDown);
                    layerControl.addEventListener("mouseout", moveSearchContainerUp);
                }
            };
            charitySearchButton.addEventListener("click", function () {
                charitySearchContainer.classList.toggle("leaflet-control-geocoder-expanded");
                charitySearchInput.focus();
            });
            charitySearchInput.addEventListener("focusout", function () {
                charitySearchContainer.classList.remove("leaflet-control-geocoder-expanded");
            });
            charitySearchInput.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    var searchValue = charitySearchInput.value.trim();
                    if (!searchValue) {
                        showToast("Please enter a valid charity registration number.");
                        return;
                    }
                    var found = !1;
                    var charity = charityData.find(function (charity) {
                        return charity.charityRegNumber.toLowerCase() === searchValue.toLowerCase();
                    });
                    if (!charity) {
                        charity = groupData.find(function (group) {
                            return group.charityRegNumber.toLowerCase() === searchValue.toLowerCase();
                        });
                    }
                    if (charity) {
                        map.setView([charity.lat, charity.lon], 16);
                        var marker = L.marker([charity.lat, charity.lon]).addTo(map);
                        marker.bindPopup(charity.popupContent).openPopup();
                        charitySearchInput.value = "";
                    } else {
                        showToast("Charity or Group not found or address couldn't be geocoded.");
                    }
                }
            });
            var geocoderControl = L.Control.geocoder({ defaultMarkGeocode: !1, geocoder: L.Control.Geocoder.nominatim() })
                .on("markgeocode", function (e) {
                    var bbox = e.geocode.bbox;
                    var locationName = e.geocode.name;
                    var poly = L.polygon([
                        [bbox.getSouthEast().lat, bbox.getSouthEast().lng],
                        [bbox.getNorthEast().lat, bbox.getNorthEast().lng],
                        [bbox.getNorthWest().lat, bbox.getNorthWest().lng],
                        [bbox.getSouthWest().lat, bbox.getSouthWest().lng],
                    ]).addTo(map);
                    polygons.push(poly);
                    map.fitBounds(poly.getBounds());
                    showToast("Search moved to: " + locationName);
                })
                .addTo(map);
            var clearControl = L.Control.extend({
                options: { position: "topright" },
                onAdd: function (map) {
                    var container = L.DomUtil.create("div", "leaflet-bar custom-clear-control");
                    var button = L.DomUtil.create("a", "", container);
                    button.innerHTML = "Clear";
                    button.title = "Clear Search Areas";
                    button.href = "#";
                    L.DomEvent.on(button, "click", function (e) {
                        L.DomEvent.preventDefault(e);
                        polygons.forEach(function (poly) {
                            map.removeLayer(poly);
                        });
                        polygons = [];
                    });
                    return container;
                },
            });
            map.addControl(new clearControl());
            function showToast(message) {
                var toast = document.getElementById("toast");
                toast.innerHTML = message;
                toast.className = "toast show";
                setTimeout(function () {
                    toast.className = toast.className.replace("show", "");
                }, 3000);
            }
        </script>
        <div id="toast" class="toast">Search moved to:</div>
    </body>
</html>
